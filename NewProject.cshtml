@model(List<dynamic>, List<dynamic>)
@{
    ViewBag.Title = "NewProject";
    Layout = "~/Views/Shared/NewThema/_LayoutTakvim.cshtml";
}
<style>
    .bootstrap-select {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

    .form-control {
        border: 1px solid var(--thBorder) !important;
        border-radius: 6px !important;
    }

    input[type="file"] {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .custom-file-upload {
        margin: 10px 0;
        padding: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        border: 1px dotted #ebebeb;
        border-radius: 5px;
    }

        .custom-file-upload:hover {
            background-color: #81b9e51c;
            cursor: pointer;
        }

        .custom-file-upload:active {
            background-color: #81b9e51c;
        }

    .TemplateDownloadButton {
        background-color: #e8fff3;
        color: #50cd89;
        padding: 4px;
        border-radius: 4px;
    }

        .TemplateDownloadButton:hover {
            background-color: #50cd89 !important;
            color: #fff !important;
        }
</style>
<link href="~/Content/SweetAlert2/sweetalert2.min.css" rel="stylesheet" />
<link href="~/Content/fileUpload/css/style.css" rel="stylesheet" />
<div class="d-flex flex-column flex-root" id="deneme">
    <div class="page d-flex flex-row flex-column-fluid">
        <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
            <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                <div class="post d-flex flex-column-fluid" id="kt_post">
                    <div id="kt_content_container" class="container-xxl">
                        <div class="row mt-5 mb-5">
                            <div class="col-lg-12">
                                <div class="card" style="border:none !important">
                                    <div class="card-body">
                                        <h4 class="mt-0 header-title">Yeni Proje Ekle</h4>
                                        <p class="text-muted mb-3">
                                            Lütfen proje bilgilerini aşağıda istenen şekilde giriniz !
                                        </p>
                                        <div>
                                            @using (Html.BeginForm("Create", "Project", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                            {
                                                @Html.AntiForgeryToken()

                                                <div class="form-group row">
                                                    <label for="example-text-input" class="col-sm-2 col-form-label text-left">Proje Adı</label>
                                                    <div class="col-sm-10">
                                                        <input class="Input-Medium col-12 inputValidateControl" type="text" placeholder="Proje adı yazınız..." value="" id="ProjectName" name="ProjectName" required>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="example-email-input" class="col-sm-2 col-form-label text-left">Firma</label>
                                                    <div class="col-sm-10">
                                                        <select class="selectpicker font13 selectValidateControl p-0" id="SelectCompanyId" data-live-search="true" data-live-search-style="contains" data-show-subtext="true" name="CompanyId" required>
                                                            <option data-tokens="" value="0">Firma Adı Arayınız...</option>
                                                            @foreach (var t in Model.Item1)
                                                            {
                                                                <option data-tokens="" data-hesapkod="@t.HESAPKOD" value="@t.ANAHESAPKOD">@t.UNVAN</option>
                                                            }
                                                        </select>
                                                        <input type="hidden" id="SelectedCompanyText" name="SelectedCompanyText" value="">
                                                        <input type="hidden" id="SelectedCompanyValue" name="SelectedCompanyValue" value="">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="example-tel-input" class="col-sm-2 col-form-label text-left">Sözleşme</label>
                                                    <div class="col-sm-10">
                                                        <select class="Dropdown col-lg-12 col-md-12 col-sm-12 mt-2 Input-Medium selectValidateControl" id="SelectContractId" name="Contract" required>
                                                            <option value="">Seçiniz</option>
                                                        </select>
                                                        <input type="hidden" id="SelectedContractText" name="SelectedContractText" value="">
                                                        <input type="hidden" id="SelectedContractValue" name="SelectedContractValue" value="">
                                                    </div>
                                                </div>
                                                <div class="form-group row rowAuthorized" style="display: none;">
                                                    <label for="example-tel-input" class="col-sm-2 col-form-label text-left"></label>
                                                    <div class="col-sm-10">
                                                        <span class="svg-icon svg-icon-primary me-4 mb-1" style="color: #009ef7;" title="Eksik firma yetkilisi olduğunu düşünüyorsanız, CPM Satış Temsilcimizle ile iletişime geçiniz.">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                                                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
                                                            </svg>
                                                            Eksik firma yetkilisi olduğunu düşünüyorsanız, lütfen CPM Satış Temsilcimizle ile iletişime geçiniz.
                                                        </span>
                                                        <div class="notice d-flex bg-light-primary rounded border-dashed rounded-3 p-3" style="border: 1px dashed #e4e6ef;">

                                                            <!--begin::Wrapper-->
                                                            <div class="d-flex flex-stack flex-grow-1">
                                                                <!--begin::Content-->
                                                                <div class="fw-semibold">
                                                                    <h7 class="text-gray-900 fw-bold mb-1">Firma Yetkilileri</h7>
                                                                    <div class="fs-9 text-gray-700" id="AuthorizedContainer">

                                                                    </div>
                                                                </div>
                                                                <!--end::Content-->
                                                            </div>
                                                            <!--end::Wrapper-->
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="example-tel-input" class="col-sm-2 col-form-label text-left">Açıklama</label>
                                                    <div class="col-sm-10">
                                                        <textarea class="form-control inputValidateControl" rows="7" id="Description" name="Description" required> </textarea>
                                                    </div>
                                                </div>
                                                <br />
                                                <a class="" href="/Project/SampleExcelTemplateDownload">
                                                    <i class="sc-download TemplateDownloadButton">&nbsp; Örnek Şablon İndir</i>
                                                </a>
                                                <br />
                                                <div class="file-upload">
                                                    <label for="sendFile" class="custom-file-upload">
                                                        <font class="font-14 font-weight-bold">DOSYA YÜKLE</font><br /><font>Lütfen proje adımlarına ait excel doyanızı yüklemek için tıklayınız</font>
                                                        <br /><font class="" id="fileName"></font>
                                                    </label>
                                                    <input type="file" name="sendFile" id="sendFile" />
                                                </div>
                                                <br />
                                                <input class="btn btn-primary float-end" type="submit" value="Gönder" />
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="~/Scripts/SweetAlert2/sweetalert2.all.min.js"></script>
<script src="~/Content/fileUpload/js/jquery.ui.widget.js"></script>
<script src="~/Content/fileUpload/js/jquery.iframe-transport.js"></script>
<script src="~/Content/fileUpload/js/jquery.fileupload.js"></script>
<script src="~/Content/fileUpload/js/jquery.knob.js"></script>
<script src="~/Content/fileUpload/js/script.js"></script>

<script>
    $(document).ready(function () {
        $('input[type="file"]').change(function (e) {
            var fileName = e.target.files[0].name;
            $('#fileName').text(fileName).addClass('badge-light-info');
        });
    });
        $(function () {
        var message = '@TempData["Message"]';
            if (message != null && message != "")
            {
            toastr.info(message);
        }
    });
    $(function () {
        // SelectCompanyId için event dinleyicisi
        $('#SelectCompanyId').on('change', function () {
            var selectedOption = $(this).find('option:selected');
            $('#SelectedCompanyText').val(selectedOption.text());
            $('#SelectedCompanyValue').val(selectedOption.val());
        });

        // SelectContractId için event dinleyicisi
        $('#SelectContractId').on('change', function () {
            var selectedOption = $(this).find('option:selected');
            $('#SelectedContractText').val(selectedOption.text());
            $('#SelectedContractValue').val(selectedOption.val());
        });
    });

    //#region Input ve Selectbox Kontrolleri
    function inputControl(üstDiv) {

        $(üstDiv + " .inputValidateControl").each(function () {
            if ($(this).val() == "") {
                $(this).attr("style", "border:1px solid var(--thRed)!important;border-radius:6px;padding-top:7px;padding-bottom:7px;");
            }
            else {
                $(this).attr("style", "border:1px solid var(--thGreen)!important;border-radius:6px;padding-top:7px;padding-bottom:7px;");
            }
        });
    }
    function selectControl(üstDiv) {
        $(üstDiv + " .selectValidateControl").each(function () {
            if ($(this).find('option:selected').val() == "" || $(this).find('option:selected').val() == 0 || $(this).find('option:selected').length < 1) {
                $(this).attr("style", "border:1px solid var(--thRed)!important; border-radius:6px");
            }
            else {
                $(this).attr("style", "border:1px solid var(--thGreen)!important; border-radius:6px");
            }
        });
    }
    //#endregion

    // #region Gunun Tarihini ve Saatini Getirme
    try {
        /*Günün tarihini alma ve formatlama) */
        Date.prototype.getValidFormat = function () {
            var ay = this.getMonth() + 1;
            var gun = this.getDate();
            var yil = this.getFullYear();
            return yil + "-" + (ay < 10 ? "0" + ay : ay) + "-" + (gun < 10 ? "0" + gun : gun); //Gün ve ay 10 dan küçükse başına 0 gelir
        };
        var date = new Date();
        $(".tarihGetir").val(date.getValidFormat());
    } catch (error) {
        console.error(error);
    }
    // #endregion
    //#region Dosyaları diziye atar
    window.filesArray = [];
    window.type = [];
    $("#multipleFile").on("change", function (e) {
        var files = e.target.files;
        var validImageTypes = ["image/gif",
            "image/jpeg",
            "image/png",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "application/vnd.ms-excel",
            "application/msword",
            "application/x-zip-compressed",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "application/pdf"];
        $.map(files, function (val) {
            if (validImageTypes.includes(val.type)) {
                window.filesArray.push(val);
            }
            return val.type;
        });
    });
    //#endregion

    // #region Firmaya Ait Sozlesmeleri Getir
    try {
        $("body").on("change", "#SelectCompanyId", function () {
            var CompayId = $("#SelectCompanyId option:selected").val();
            var CompanyName = $("#SelectCompanyId option:selected").text();
            var SelectContractId = $("#SelectContractId");
            var requiredTime1 = $("#requiredTime1");
            requiredTime1.html("");
            if (CompayId != "" && CompanyName != "Seçiniz") {
                $.ajax({
                    url: '/CpmServisSistemi/GetCompanyContract',
                    type: 'POST',
                    dataType: 'json',
                    data: { 'COMPANYID': CompayId },
                    success: function (data) {
                        SelectContractId.empty();
                        SelectContractId.append('<option value="" selected>Seçiniz</option>');
                        $.each(data.CompanyContracts2, function (index, option) {
                            SelectContractId.append('<option data-id=' + option.COMPANYID + ' value=' + option.ID + '>' + option.COMPANYCONTRACT + '</option>');
                        });

                    }
                });
            }
        });
    }
    catch (error) {
        console.error(error);
    }
    // #endregion

    // #region Firmaya Ait Yetkilileri Getir
    try {
        $("body").on("change", "#SelectCompanyId", function () {
            var CompayId = $("#SelectCompanyId option:selected").val();
            if (CompayId != "") {
                $.ajax({
                    url: '/Project/GetCompanyAuthorized',
                    type: 'POST',
                    dataType: 'json',
                    data: { 'COMPANYID': CompayId },
                    success: function (data) {
                        if (data.length !== 0) {
                            console.log(data);
                            var rowAuthorized = $(".rowAuthorized");
                            rowAuthorized.show();
                            var authorizedContainer = $("#AuthorizedContainer");
                            authorizedContainer.empty(); // Önceki içeriği temizle

                            $.each(data, function (index, item) {
                                var fullName = item.FullName;
                                if (fullName!=null) {
                                    var content = "<p class='mb-0'>" + (index + 1) + ". " + fullName + "</p>";
                                    authorizedContainer.append(content);
                                }                            });
                        }
                        else
                        {
                            var authorizedContainer = $("#AuthorizedContainer");
                            authorizedContainer.empty(); // Önceki içeriği temizle
                            var content = "<p class='mb-0'>Firmaya ait herhangi bir yetkili bulamadık!</p>";
                            authorizedContainer.append(content);
                        }
                     
                    }
                });
            }
        });
    }
    catch (error) {
        console.error(error);
    }
    // #endregion


    //#region Proje Kaydet
    $('body').on('click', '#SubmitProject', function () {
        inputControl("#kt_content_container");
        selectControl("#kt_content_container");
        var ProjectName = $("#ProjectName").val() == '' ? '' : $("#ProjectName").val();
        var CompanyId = $("#SelectCompanyId option:selected").val() == '' ? '' : $("#SelectCompanyId option:selected").val();
        //var SelectPersonId = $("#SelectPersonId option:selected").val() == '' ? '' : $("#SelectPersonId option:selected").val();
        var CompanyName = $("#SelectCompanyId option:selected").text() == '' ? '' : $("#SelectCompanyId option:selected").text();
        var ContractId = $("#SelectContractId option:selected").attr("data-id") == '' ? '' : $("#SelectContractId option:selected").attr("data-id");
        var ContractName = $("#SelectContractId option:selected").text() == '' ? '' : $("#SelectContractId option:selected").text();
        var Description = $("#Description").val() == '' ? '' : $("#Description").val();
        var REQUIRED = [];
        var PERSONID = [];
        $(".getSteps .requiredTimes").each(function () {
            REQUIRED.push($(this).val());
        });
        $(".getSteps .persons option:selected").each(function () {
            PERSONID.push($(this).val());
        });
        var fileData = new FormData(); //Dosyalar
        for (var i = 0; i < window.filesArray.length; i++) {
            fileData.append(window.filesArray[i].name, window.filesArray[i]);
        }
        var filecount = window.filesArray.length;

        if (CompanyId == '' || ProjectName == '' || ContractId == '' || Description == '' || TOTALID.includes('') || REQUIRED.includes('')) {
            Swal.fire(
                'Dikkat !',
                'Lütfen, kırmızı alanları doldurunuz !',
                'warning'
            )
        }
        else {
            $.blockUI({
                message: '<lottie-player autoplay  loop mode="normal" src="/Scripts/LottieFiles/cpm-loading-sc.json" style="width: 320px"></lottie-player>',
            });
            $.ajax({
                method: "POST",
                url: '/Project/SaveNewProject',
                data:
                {
                    ProjectName: ProjectName,
                    CompanyId: CompanyId,
                    CompanyName: CompanyName,
                    ContractId: ContractId,
                    ContractName: ContractName,
                    Description: Description,
                },
                success: function (result) {

                    if (result.IsSuccess == true && filecount > 0) {
                        $.ajax({
                            type: 'POST',
                            url: "/Project/UploadProjectFiles",
                            data: fileData,
                            dataType: "json",
                            contentType: false,
                            processData: false,
                            success: function (result) {
                                if (result.IsSuccess == true) {
                                    toastr.success(result.Message);
                                    window.location = "/Project/NewProject";
                                }
                                else {
                                    toastr.error(result.Message);
                                }
                            },
                            error: function () {
                                alert('Erişim sağlanamadı.');
                            }
                        });
                        setTimeout($.unblockUI, 500);
                        toastr.success(result.Message);
                    }
                 
                    else {
                        window.location = "/Project/NewProject";
                    }
                },
                error: function () {
                    alert('Erişim sağlanamadı.');
                }
            });
        }
    });
    // #endregion
    // #region Firmaya Ait Kalan Adam Gün Getir
    try {
        $("body").on("change", "#SELECTCONTRACTID", function () {
            var COMPANYID = $("#SELECTCONTRACTID option:selected").val();
            var COMPANY = $("#SELECTCONTRACTID option:selected").text();
            var ID = $("#SELECTCONTRACTID option:selected ").attr('data-id');
            var RSERVICEDAY = $("#RSERVICEDAY");
            if (COMPANYID != "" && COMPANY != "Seçiniz") {
                $.ajax({
                    url: '/CpmServisSistemi/GetCompanyRemainderServiceDay',
                    type: 'POST',
                    dataType: 'json',
                    data: { 'COMPANYID': COMPANYID, 'ID': ID },
                    success: function (data) {
                        RSERVICEDAY.empty();
                        $.each(data.CompanyContracts2, function (index, option) {
                            RSERVICEDAY.append(option.RSERVICEDAY);
                        });

                    }
                });
            }
        });
    }
    catch (error) {
        console.error(error);
    }
    // #endregion
</script>

